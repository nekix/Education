name: Deploy to VPS

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Deployment mode'
        required: true
        default: 'minimal'
        type: choice
        options:
        - minimal
        - demo

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.CAR_PARK_SERVER_HOST }}
        username: ${{ secrets.CAR_PARK_SERVER_USER }}
        password: ${{ secrets.CAR_PARK_SERVER_PASSWORD }}
        port: ${{ secrets.CAR_PARK_SERVER_PORT }}
        command_timeout: 60m
        script: |
          set -e
          export POSTGRES_DB="${{ secrets.CAR_PARK_POSTGRES_DB }}"
          export POSTGRES_USER="${{ secrets.CAR_PARK_POSTGRES_USER }}"
          export POSTGRES_PASSWORD="${{ secrets.CAR_PARK_POSTGRES_PASSWORD }}"
          export GRAPHHOPPER_API_KEY="${{ secrets.CAR_PARK_GRAPHHOPPER_API_KEY }}"
          export DADATA_TOKEN="${{ secrets.CAR_PARK_DADATA_TOKEN }}"
          export DEMO_SEED="${{ secrets.CAR_PARK_DEMO_SEED }}"
          export DEMO_START_DATE="${{ secrets.CAR_PARK_DEMO_START_DATE }}"
          export DEMO_END_DATE="${{ secrets.CAR_PARK_DEMO_END_DATE }}"
          export WEB_PORT="${{ secrets.CAR_PARK_WEB_PORT }}"
          # Create .env file
          cat > ~/.env << EOF
          POSTGRES_DB=$POSTGRES_DB
          POSTGRES_USER=$POSTGRES_USER
          POSTGRES_PASSWORD=$POSTGRES_PASSWORD
          GRAPHHOPPER_API_KEY=$GRAPHHOPPER_API_KEY
          DADATA_TOKEN=$DADATA_TOKEN
          DEMO_SEED=$DEMO_SEED
          DEMO_START_DATE=$DEMO_START_DATE
          DEMO_END_DATE=$DEMO_END_DATE
          WEB_PORT=$WEB_PORT
          EOF
          wget -q https://raw.githubusercontent.com/nekix/Education/main/Project/CarPark/deploy/deploy.sh -O deploy.sh
          chmod +x deploy.sh
          ./deploy.sh -e ~/.env -m ${{ inputs.mode }} -g https://github.com/nekix/Education.git
