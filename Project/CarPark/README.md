# Автопарк

Строка подключения к базе данных: `ConnectionStrings:Default`

API Vehicles: `/vehicles`

## Обзор проекта

### Архитектура системы
Проект состоит из двух основных компонентов:
- **Административная панель** (MVC/Razor Views) - техническая админка для управления сущностями
- **REST API** - основная часть для клиентов api

**Подробную документацию UI см. в [UI.md](UI.md)**
**Спорные моменты см. в [CONTROVERSIAL_ISSUES.md](CONTROVERSIAL_ISSUES.md)**

### API Endpoints
- **Полная API документация**: См. [API.md](API.md)
- **Swagger UI**: Доступен в режиме разработки на `/swagger`
- **Основные API**: `/api/vehicles`, `/api/models`, `/api/drivers`, `/api/enterprises`, `/api/auth`

## Модель данных

### Основные сущности
- **Model** - модель автомобиля
- **Vehicle** - автомобиль конкретной модели
- **Enterprise** - предприятие (автопарк)
- **Driver** - водитель
- **Manager** - менеджер (наследник от стандартного пользователя)

### Связи между сущностями

#### Предприятие (Enterprise)
- **Один ко многим** с автомобилями (Vehicle)
- **Один ко многим** с водителями (Driver)
- **Один ко многим** с менеджерами (Manager)

#### Автомобиль (Vehicle)
- Принадлежит **только одному** предприятию
- Может иметь **несколько назначенных** водителей
- Имеет **одного активного** водителя (или null)
- При создании **не привязан** к водителям

#### Водитель (Driver)
- Принадлежит **только одному** предприятию
- Может быть назначен на **несколько автомобилей**
- Может быть **активным** только на одной машине
- При создании **не привязан** к автомобилям

#### Менеджер (Manager)
- Может управлять **несколькими предприятиями**
- Видит только объекты из **управляемых предприятий**
- Получает в REST-запросах только данные **управляемых предприятий**

## Система авторизации

### Типы пользователей
1. **Обычный пользователь** - базовая авторизация без доступа к ограниченным ресурсам
2. **Менеджер** - расширенные права с доступом к управлению предприятиями

### Политики доступа
- **401 Unauthorized** - пользователь не авторизован или неверные учетные данные
- **403 Forbidden** - пользователь авторизован, но доступ запрещен
  - Обычный пользователь пытается получить доступ к ресурсам менеджера
  - Менеджер пытается получить доступ к "невидимым" ему предприятиям
- **400 Bad Request** - некорректный запрос

## Защита от CSRF атак

### Реализация защиты
- Использование `ValidateAntiForgeryToken` атрибута
- POST запросы без CSRF токена возвращают **403 Forbidden**
- Настроена глобальная конфигурация приложения

### Стратегии тестирования CSRF защиты

#### Возможные уровни проверки
1. **Конфигурация приложения** - проверка включенных зависимостей для CSRF
2. **Автоматическое выявление уязвимых эндпоинтов** - через Reflection и DI контейнер
3. **Ручной список эндпоинтов** - указанные вручную точки проверки

#### Варианты способов проверки
1. **Через Reflection и DI** - проверка установки нужных сервисов и атрибутов
2. **Интеграционные тесты** - запросы с токенами и без для проверки работы защиты

> **Выбор подхода**: Если нужно проверить работоспособность фреймворка - интеграционные тесты. Если доверяем фреймворку, но не доверяем себе - рефлексия для проверки настроек.

#### Реализованные тесты
1. **Тест без CSRF токена** - отправка валидных данных без токена → ожидается 403
2. **Тест с CSRF токеном** - предварительное получение токенов и валидный запрос → ожидается 302

## Функциональность

### CRUD операции
- **UI интерфейс** - полный CRUD для моделей и автомобилей (подробности в [UI.md](UI.md))
- **REST API** - полный CRUD для моделей и автомобилей, только чтение для водителей и предприятий (подробности в [API.md](API.md))

### Текущая реализация REST API
- Списки связанных сущностей выдаются **списком ID**
- Менеджеры получают только данные управляемых им предприятий
- Реализован полный CRUD для автомобилей и моделей
- Доступ только для чтения к водителям и предприятиям

## Бизнес-логика и ограничения

### Логическая консистентность
При нарушении логической консистентности возвращается **409 Conflict**:
- Попытка удаления предприятия с автомобилями или водителями
- Удаление автомобиля с активным водителем
- Удаление модели, используемой в действующих автомобилях
- Удаление предприятия, видимого другим менеджерам

### Подробные бизнес-правила

**Все бизнес-правила и ограничения подробно описаны в**: [BUSINESS_RULES.md](BUSINESS_RULES.md)

#### Краткий обзор:

**Автомобили**: Менеджер управляет только автомобилями своих предприятий
**Предприятия**: Удаление только при единоличном управлении
**Модели**: Глобальные данные с защитой от удаления используемых
**Контроль доступа**: Проверка прав на все операции изменения данных

## Тестирование

### Типы тестов статус-кодов

#### 1. Глобальные тесты (один на проект)
- **Цель**: Проверка аннотации эндпоинтов для Swagger/OpenAPI
- **Механизм**: Рефлексия для проверки разрешенных статус-кодов
- **Дополнение**: Статический анализатор переводит предупреждения в ошибки компиляции
- **Ограничения**: Не всегда отрабатывает из-за middleware и фильтров ASP.NET Core

#### 2. Специфичные тесты (на каждый эндпоинт)
- **Цель**: Точная проверка работы конкретного эндпоинта
- **Механизм**: Вызов с конкретными параметрами → проверка статус-кода
- **Преимущества**: Возможность проверки тела ответа и заголовков
- **Недостатки**: Требует написания тестов для каждого эндпоинта

### Разрешенные статус-коды по HTTP методам
Подробное описание кодов ответов см. в [API.md](API.md#коды-ответов)

## Рекомендации и архитектурные решения

### Рекомендации по управлению связями
Выбор направления связей зависит от типов запросов и требует анализа для выбора:
- **Vehicle → Driver (активный)** - проще найти активного водителя для машины
- **Driver → Vehicle (рабочий)** - проще найти машину водителя  
- **Отдельный эндпоинт** - для выдачи всех активных водителей с машинами по предприятию

> **Примечание**: Выбор зависит от возможной нагрузки и преимущественно планируемых запросов в конкретном проекте.

### Рекомендации по проектированию
- Избегание примитивных типов в доменных моделях
- Отказ от лишних сущностей для абстрактных связей  
- Эффективность запросов в зависимости от нагрузки проекта

### Рекомендации по REST API
- Списки связанных сущностей выдавать **списком ID**
- Фронтенд самостоятельно запрашивает дополнительную информацию по сущностям
- Рассматривать отдельные эндпоинты для сложных выборок

### Рекомендации по улучшению тестирования CSRF и API
- **Расширение статического анализа**: Можно разработать отдельный статический анализатор вместо использования тестов
- **Комбинирование подходов**: Успешно применяется комбинация проверки конкретных эндпоинтов через рефлексию и интеграционные тесты
- **Ограничения встроенного анализа**: ASP.NET Core анализатор не всегда учитывает статус-коды от middleware и фильтров (401, 403, 500)

## Конфигурация

### Строка подключения к БД
```
ConnectionStrings:Default
```

### Статический анализ
Настроен анализатор для обязательной аннотации статус-кодов эндпоинтов, предупреждения переведены в ошибки компиляции.

## Генератор тестовых данных

### Обзор компонента
Проект включает утилиту `CarPark.DataGenerator` для создания тестовых данных. Генератор предназначен для заполнения базы данных автомобилями и водителями для существующих предприятий.

### Архитектура генератора

#### Основные компоненты
- **DataGeneratorV2** - основной класс генерации данных
- **Program.cs** - CLI интерфейс с использованием System.CommandLine
- **Dtos.cs** - структуры для сериализации в JSON

#### Принципы работы
1. **Загрузка существующих данных** - модели и предприятия загружаются из БД
2. **Генерация новых сущностей** - создание автомобилей и водителей
3. **Установка связей** - автоматическое связывание автомобилей с водителями
4. **Транзакционное сохранение** - все операции выполняются в транзакции

### CLI интерфейс

#### Команда генерации
```bash
dotnet run generate vehicles-drivers [параметры]
```

#### Обязательные параметры
- `--enterprise-ids` - список ID предприятий через запятую
- `--vehicles-per-enterprise` - количество автомобилей на предприятие
- `--drivers-per-enterprise` - количество водителей на предприятие
- `--connection-string` - строка подключения к БД

#### Опциональные параметры
- `--output` - путь к JSON файлу для сохранения результатов